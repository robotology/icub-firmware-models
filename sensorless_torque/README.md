
# LuGre Friction Model

The **LuGre Friction Model** is a dynamic friction model used to represent the complex behavior of friction in mechanical systems. It enhances traditional friction models by introducing state variables to describe the internal microscopic effects at the contact interface, such as stick-slip phenomena.

Reference paper: [Revisiting the LuGre friction model](https://ieeexplore.ieee.org/document/4653109)

## Table of Contents
1. [Introduction](#introduction)
2. [Mathematical Representation](#mathematical-representation)
3. [Parameters of the LuGre Model](#parameters-of-the-lugre-model)
4. [Friction Regimes](#friction-regimes)
5. [Conclusion](#conclusion)

---

## Introduction

The LuGre model was introduced to overcome limitations of classical friction models like Coulomb and viscous friction. The LuGre model adds dynamics to friction, meaning the friction force depends on a state variable representing the deflection of the asperities between the two sliding surfaces. This makes the model capable of capturing more realistic frictional behaviors such as pre-sliding displacement, stick-slip motion, and varying friction with velocity. It makes use of a "bristle" analogy as in the picture below:

![Bristle](assets/Bristle.png)

---

## Mathematical Representation

The LuGre friction model is defined by the following set of equations:

### 1. State equation
The state variable $z$ represents the deflection of bristles at the friction contact:

$$
\dot{z} = v - \sigma_0 \frac{|v|}{g(v)} z
$$

where:
- $v$ is the relative velocity between the two surfaces.
- $z$ is the internal state variable representing the bristle deformation.
- $\sigma_0$ is the stiffness coefficient of the bristles.
- $g(v)$ is the model of the Stribeck effect

$$
g(v) = F_c + |F_s - F_c| e^{-|\frac{v}{V_{th}}|^\alpha}
$$

$\alpha$ is typically equal to 1.

### 2. Friction force equation
The total friction force is given by:

$$
F_f = \sigma_0 z + \sigma_1 \dot{z} + K_w v
$$

where:
- $\sigma_0$ is the stiffness coefficient of the bristles.
- $\sigma_1$ is the damping coefficient of the bristles.
- $K_w$ is the viscous friction coefficient.

![Stribeck](assets/Stribeck.png)

---

## Parameters of the LuGre Model

The model has several parameters, which need to be tuned according to the system being simulated:

1. **$\sigma_0$**: Stiffness coefficient – represents the rigidity of microscopic surface asperities.
2. **$\sigma_1$**: Damping coefficient – describes the energy dissipation during deformation of surface asperities.
3. **$K_w$**: Viscous friction coefficient – accounts for the viscous effect at high velocities.
4. **$F_c$**: Coulomb friction force – the steady-state friction force at constant velocity.
5. **$F_s$**: Static friction force – the maximum force that resists motion before sliding occurs.
6. **$V_{th}$**: Stribeck velocity – the velocity at which the friction starts to drop from static to kinetic friction.

---

## Friction Regimes

The LuGre model describes three main friction regimes:

1. **Pre-sliding regime**: Occurs at very low velocities where the deformation of the bristles governs the friction force.
2. **Stiction (stick-slip) regime**: Represents alternating sticking and slipping behavior.
3. **Sliding regime**: At higher velocities, the model behaves like traditional dynamic friction models with viscous and Coulomb friction components.

---

### Friction Force vs. Velocity
The following plot shows the friction force as a function of relative velocity. The LuGre model captures the Stribeck effect, where friction decreases as velocity increases from zero, followed by a steady Coulomb friction force.

![Friction Force vs Velocity](assets/Plot.png)

  
---

## Conclusion

The LuGre friction model provides an advanced way to simulate realistic friction behaviors, addressing limitations in traditional models. By introducing a state variable to describe internal surface dynamics, the model captures the effects of both static and dynamic friction.

---

# Embedded firmware generation
The TorqueEstimator subsystem is already configured for embedded software generation. 

![TorqueEstimator](assets/TorqueEstimator.png)

The source code is generated by right clicking on the `TorqueEstimator` subsystem, and choosing `C/C++ Code > Build This Subsystem`, in this way:

![code generation](assets/Generation.png)

Once this is done, the .h and .cpp files contained in the TorqueEstimator.zip generated in the main folder must be properly placed into the board firmware project. 
For example, with the EMS board:

![project](assets/Project.png)

that corresponds to the folder `icub-firmware\emBODY\eBcode\arch-arm\mbd\torque_estimator`

![folder](assets/Folder.png)


# LuGre parameters estimation
An automatic parameter estimation tool is provided:
- [`param_estimator.m`](param_estimator.m)

The algorithm uses brute force in iterative steps, starting from a wide range of possible values and coarse quantization, and going on narrowing the range and increasing the resolution at each step. Each step tries all the possible combinations of the parameters involved, and with this set of parameter values it performs a full net torque calculation given the current and velocity sequence provided, and then it compares the calculated torque curve with the measured one, keeping track of the combination that gives the best result in the sense of RMSE. 
Since the number of parameters is still quite high, the algorithm estimates the LuGre parameters in 3 stages:

1.  `Km` (motor torque constant), `Kw` (viscous friction constant), `Fc` (Coulomb force constant);
2.  `Fs` (Stribeck force constant), `Vth` (Stribeck force velocity threshold);
3.  `S0`, `S1` (LuGre hysteresis model stiffness and damping).

The search space must be initially limited in some way, thus the `Km` torque constant, `Kw` viscous friction constant and `Fc` Coulomb force constant initial ranges are restricted to 1/5x to 5x the values measured in the ergoCub new medium joint, covering in this way a wide range of present and future joint sizes.


## Data input format
The script requires an input with a 4xN matrix containing:

1.  time [s];
2.  measured current [A];
3.  measured velocity [rad/s], motor side;
4.  measured joint torque [Nm], joint side.

The data source experiment should be in some way meaningful: i.e., undergoing typical velocity and torque, back and forth motion cycles, time duration > 20 s, about 1 kHz sample rate. 

Example data file: [ergojoint_mid_calibration.mat](data/ergojoint_mid_calibration.mat)

![Example data plot](assets/DataExample.png)

The file path must be inserted in the script first lines, here:

![Input filepath](assets/FilePath.png)

## Calculations and output
After a bunch of seconds (depending on the size of the dataset), the output is provided in this format:

![Ouput](assets/Output.png)

The output parameter values can be copied in the corresponding LUGRE section of the hardware/motorControl robot configuration .xml files.
